<div class="flex flex-col mb-4">
  <mat-expansion-panel expanded>
    @let p = parties();
    <mat-expansion-panel-header>
      <mat-panel-title class="gap-1 justify-between">
        <span class="flex gap-1 parties">
          Parties: @if (p[0]) {
          <mat-chip class="orange">{{ p[0].shortName }}</mat-chip>
          } @if (p[1]) {
          <mat-chip class="sky">{{ p[1].shortName }}</mat-chip>
          } @if (p.length > 2) {
          <mat-chip class="more">+{{ p.length - 2 }}</mat-chip>
          }
        </span>
        <button mat-stroked-button>ADD</button>
      </mat-panel-title>
    </mat-expansion-panel-header>
    <div class="grid grid-cols-6 gap-4">
      @for (party of p; track party.id) {
      <div class="pt-3">{{ party.shortName }}:</div>
      <div class="col-span-5">
        <mat-form-field
          class="w-full"
          appearance="outline"
          subscriptSizing="dynamic"
        >
          <mat-chip-grid class="more" #stateChipGrid>
            @for (state of selectedStates()[party.id]; track state.id) {
            <mat-chip-row (removed)="stateRemove(state.id, party.id)">
              {{ state.name }}
              <button matChipRemove>
                <mat-icon>close</mat-icon>
              </button>
            </mat-chip-row>
            }
            <input
              #stateInput
              [matChipInputFor]="stateChipGrid"
              [matAutocomplete]="stateAutocomplete"
              [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
            />
            <mat-autocomplete
              #stateAutocomplete="matAutocomplete"
              (optionSelected)="
                stateSelected($event, party.id); stateInput.value = ''
              "
            >
              @for (state of filteredStates()[party.id]; track state.id) {
              <mat-option [value]="state">{{ state.name }}</mat-option>
              }
            </mat-autocomplete>
          </mat-chip-grid>
          <button
            mat-icon-button
            matSuffix
            (click)="toggleSettings($event, party.id)"
          >
            <mat-icon matSuffix>settings</mat-icon>
          </button>
        </mat-form-field>
      </div>
      }
    </div>
  </mat-expansion-panel>
</div>
